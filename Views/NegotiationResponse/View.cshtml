@using KwasantWeb.ViewModels

@{ Layout = "~/Views/Shared/_Layout.cshtml"; }
@section immediateScripts
{
    @Scripts.Render("~/bundles/js/jquery")
    @Scripts.Render("~/bundles/js/jqueryvalidate")
}
@section scripts
{
    @Scripts.Render("~/bundles/js/modernizr")
    @Scripts.Render("~/bundles/js/bootstrap")
}
@section styles
{
    @Styles.Render("~/bundles/css/bootstrap30")
    @Styles.Render("~/bundles/css/backendcss")
}

<h2>We need clarification about the following to finish booking your event:</h2>

@foreach (NegotiationResponseQuestionViewModel question in Model.Questions)
{
    <div class="formItem">
        <label>Question : </label>
        @question.Text
    </div>
    <div class="formItem">
                @foreach (var ans in question.Answers)
        {
            <label>
                <input type="radio" name="@question.Id" value="@ans.Id" @Html.Raw(question.SelectedAnswerID == ans.Id ? "checked" : String.Empty) />   
                @ans.Text
            </label><br />
        }
        @if (question.AnswerType == "Text")
        {
            <label>
                <input type="radio" name="@question.Id" data-type="Text" value="suggestion" @Html.Raw(!String.IsNullOrEmpty(question.SelectedText) ? "checked" : String.Empty) />
                Suggest your own answer<br />
            </label>
            //We don't need a check for the selected text. Either it's empty, or they picked a different answer.
            <input type="text" style="margin-left: 16px;" value="@Html.Raw(question.SelectedText)" id="@question.Id" /><br />
        }
        else
        {
            <label>
                <input type="radio" name="@question.Id" data-type="Timeslot" value="suggestion" />
                Suggest your own answer<br />
            </label>
            <button class="pick" style="margin-left: 16px;" onclick="return false;">Pick Times</button><br />
        }
        <br />
        <br />
    </div>
}

<div class="space">
    <div style="clear: both">
        <div style="float: left">
            <input type="button" value="send" onclick="sendthis();" />
        </div>
    </div>
    <br />
    <br />
</div>

<script type="text/javascript">
    $(function() {
        $("input[type='radio']").change(updateEnabledControls);
        updateEnabledControls();
    });
    
    function updateEnabledControls() {
        $("input[type='radio']").each(function() {
            if (this.checked) {
                if ($(this).attr("data-type") == "Text") {
                    $('#' + this.name).prop('disabled', false);
                } else {
                    $('#' + this.name).prop('disabled', true);
                }
            }
        });
    }

    function sendthis() {
        var response = {};
        response.NegotiationID = @Model.Id;
        
        var answers = [];
        $("input[type='radio']").each(function () {
            if (this.checked) {
                if (this.value != "suggestion") {
                    answers.push({ QuestionID: this.name, AnswerID: this.value});
                }
                else {
                    if ($(this).attr("data-type") == "Text") {
                        answers.push({ QuestionID: this.name, Response: $('#' + this.name).val()});
                    }
                }
            }
        });
        response.Responses = answers;
        var data = JSON.stringify(response);

        $.ajax({
            type: "POST",
            dataType: 'json',
            contentType: 'application/json',
            url: '@Url.Action("ProcessResponse", "NegotiationResponse")',
            data: data
        })
            .always(function(result) {
                var newDoc = document.open("text/html", "replace");
                newDoc.write(result.responseText);
                newDoc.close();
            });
    };
</script>