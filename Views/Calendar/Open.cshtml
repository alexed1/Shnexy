@model Data.Entities.EventDO
@{ Layout = "~/Views/Shared/_Blank.cshtml"; }

<header>
    <link href="~/Content/bootstrap.min.css" rel="stylesheet" type="text/css" />
    <link href="~/Media/select2.css" rel="stylesheet" type="text/css" />
    <script type="text/javascript" src="/Scripts/select2.js"> </script>
    
    <!-- jQuery.Validate -->
    <script type="text/javascript" src="/Scripts/jquery.validate.js"> </script>

    <!-- bootstrap.datepicker -->
    <script type="text/javascript" src="/Scripts/bootstrap-datepicker.js"> </script>
    <link href="/Content/bootstrap-datepicker.css" rel="stylesheet" type="text/css" />
    <script type="text/javascript">
        $(document).ready(function() {
            var hideShowDates = function() {
                if ($('#chkAllDay').attr('checked')) {
                    $('#dateGroup').hide();
                } else {
                    $('#dateGroup').show();
                }
            };
            $('#chkAllDay').click(hideShowDates);
            hideShowDates();
            var data = [@Html.Raw(String.Join(",", Model.Attendees.Select(a =>
                            "{id: '" + a.EmailAddress + "', text: '" + a.EmailAddress + "'}"
                            )))];

            $('#attendeesSel').select2({
                createSearchChoice: function(term) {
                    return { id: term, text: term };
                },
                validateFormat: function(term) {
                    var atPos = term.indexOf('@@');
                    var dotPos = term.lastIndexOf('.');
                    if (atPos < 1 || (dotPos - atPos < 2) || (term.length - 2 <= dotPos)) {
                        return "Invalid Email";
                    }
                    return null;
                },
                multiple: true,
                data: [],
                width: '100%',
            });
            $('#attendeesSel').select2('data', data);
        });
    </script>
</header>
<form id="f" method="post" action="@Url.Action("BeforeSave")">
    <h3>
        @Html.Raw(Model.EventID == 0 ? "New Event" : "Editing Event")
    </h3>
    <hr />
    <div>Summary</div>
    <br/>
    <div>
        <input id="summary" name="Summary" class="form-control col-md-1" value="@Model.Summary" required/>
    </div>
    <br />    
    <div>
        <div style="display:inline-flex">
            <p style="padding-right:15px;">When</p>
            <label>
                <input id="chkAllDay" type="checkbox" name="IsAllDay" @Html.Raw(Model.IsAllDay ? "checked='checked'" : String.Empty) /> All day event
            </label>
        </div>
        <div class="span5 col-md-5" style="padding: 0;">
            <div class="input-daterange input-group" id="dateGroup">
                <input type="text" class="input-sm form-control" name="dateStart" />
                <span class="input-group-addon">to</span>
                <input type="text" class="input-sm form-control" name="dateEnd" />
                @*<div>
                    <label>Start
                        <input id="dateStart" name="DateStart" class="form-control col-md-1" value="@Model.StartDate" required/>
                    </label>
                </div>
                <div>
                    <label>
                        End
                        <input id="dateEnd" name="DateEnd" class="form-control col-md-1" value="@Model.EndDate" required />
                    </label>
                </div>*@
            </div>
        </div>
    </div>
    <br/>
    <div>Location</div>
    <div>
        <input id="location" name="Location" class="form-control col-md-1" value="@Model.Location" required />
    </div>
    <br />
    <div>Description</div>
    <div>
        <textarea id="description" name="Description" cols="31" rows="3" class="form-control col-md-1" required >@Html.Raw(Model.Description)</textarea>
    </div>
    <br />

    <div>Attendees</div>
    <div>
        <input type="hidden" name="Attendees" id="attendeesSel" />
    </div>
    <br />
    @{
        <div style="display: none">
            @Html.TextBox("EventID", @Model.EventID, new {@class = "form-control col-md-1"})
        </div>
    }
    <hr />
    <div class="space">
        <div style="clear: both">
            <div style="float: left">
                <input id="btnSave" type="submit" value="OK" style="border: 2px solid black; height: 30px; margin-right: 20px; width: 100px;" />
            </div>
            <div style="float: left">
                <a href="javascript:close()"><div style="width: 100px;">Cancel</div></a>
            </div>
        </div>
        <br />
        <br />
    </div>
</form>

<script type="text/javascript">
    function close(result) {
        if (parent && parent.DayPilot && parent.DayPilot.ModalStatic) {
            parent.DayPilot.ModalStatic.close(result);
        }
    }

    $("#f").submit(function() {
        var f = $("#f");
        var url = f.prop('action') + '/?' + f.serialize();
        var m = new parent.DayPilot.Modal();
        m.closed = function() {
            if (this.result == "OK") {
                close(this.result);
            }
        };

        m.showUrl(url);

        return false;
    });

    $(document).ready(function() {
        $("#summary").focus();
        $('#f').validate();

        $('#dateGroup').datepicker({});
    });

</script>