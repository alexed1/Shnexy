@model KwasantWeb.ViewModels.CalendarViewModel
@{ Layout = "~/Views/Shared/_Layout.cshtml"; }
@{
	ViewBag.Title = "Event ";
}
@section styles{
    @Styles.Render("~/bundles/css/daypilot")
}
@section immediateScripts
{
	@Scripts.Render("~/bundles/js/jquery")
	@Scripts.Render("~/bundles/js/daypilot")
    @Scripts.Render("~/bundles/js/kwasantcalendar")
    @Scripts.Render("~/bundles/js/kwasantpopup")

    <script src="~/Scripts/DataTables-1.10.0/media/js/jquery.dataTables.js"></script>
    <link href="~/Content/DataTables-1.10.0/media/css/jquery.dataTables.css" rel="stylesheet" />
}
@section scripts
{
	@Scripts.Render("~/bundles/js/modernizr")
	@Scripts.Render("~/bundles/js/bootstrap")
	@Scripts.Render("~/bundles/js/common")
}
@*width: 1270px;*@
<div class="jumbotron calendar-section jumbotron_new">
	<div class="row">
        @*width: 420px;*@

	
		<nav class="navbar navbar-default top-toolbar-section" role="navigation">
			<div class="container-fluid">

				<div class="navbar-header">
					<button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
						<span class="sr-only">Toggle navigation</span>
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
					</button>
				</div>

				<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
					<ul class="nav navbar-nav">
					<!--	<li><a id="btnProcessed" onclick="updateStatus('@Url.Action("SetStatus", "BookingRequest", new { id = Model.BookingRequestID, status = Data.Constants.BookingRequestState.Processed })');" href="#">Mark Processed</a></li> -->

                        <li><a id="btnProcessed" onclick="updateStatus('@Url.Action("MarkAsProcessed", "BookingRequest", new { id = Model.BookingRequestID })');" href="#">Mark Processed</a></li>
						<li><a id="btnRequestClarification" class="btnRequestClarification" href="#">Request Clarification</a></li>
						<li>@Html.ActionLink("Back to booking requests", "Index", "BookingRequest")</li>
						<li>@Html.ActionLink("Show Users", "Index", "User")</li>
                     
                     <li> <a id="btnHistory" onclick="HistoryClick(@Model.BookingRequestID);" class="btnHistory" href="#">History</a></li>
					</ul>
				</div>
			</div>
		</nav>

        <div id="emailInfoBox" class="col-md-5 container_box emailInfoBox">
            <iframe id="emailInfoFrame" class="frminfo" onload=" emailFrameLoaded()" src="/Api/GetEmailHTML.aspx?emailID=@Model.BookingRequestID" style=""></iframe>
            <table id="tbluserrequests" class="email-info-tabele">
                <thead>
                    <tr>
                        <th>Date Received</th>
                        <th>Subject</th>
                    </tr>
                </thead>
            </table>
            <br />
            <br />
        </div>
        
	    <div id="CalendarDiv" ></div>

	</div>
</div>
<input type="hidden" value="@Model.BookingRequestID" id="hdnrequestid" name="requestid" />

<script type="text/javascript">
    var calendar;
    $(function() {
        calendar = $('#CalendarDiv').KCalendar({
                getCalendarBackendURL: function() {
                    return '@Url.Content("~/Calendar/Day?calendarIDs=" + String.Join(",", Model.LinkedCalendarIDs))';
                },
                getMonthBackendURL: function () {
                    return '@Url.Content("~/Calendar/Month?calendarIDs=" + String.Join(",", Model.LinkedCalendarIDs))';
                },
                getNavigatorBackendURL: function() {
                    return '@Url.Content("~/Calendar/Navigator?calendarIDs=" + String.Join(",", Model.LinkedCalendarIDs))';
                },  
                getEditURL: function(id) { return '/Event/Edit/?eventID=' + id; },
                getMoveURL: function(id, newStart, newEnd) { return '/Event/MoveEvent/?eventID=' + id + '&newStart=' + newStart + 'z&newEnd=' + newEnd + 'z'; },
                getDeleteURL: function(id) { return '/Event/DeleteEvent/?eventID=' + id; },
                onEventNew: function(start, end) {
                    if (Kwasant.IFrame.PopupsActive()) {
                        return;
                    }
                    var id = $("#hdnrequestid").val();
                    Kwasant.IFrame.Display('/Event/New/?bookingRequestID=' + id + '&calendarID=' + @Model.MainCalendarID + '&start=' + start + 'z&end=' + end + 'z',
                        {
                            horizontalAlign: 'right',
                            callback: calendar.refreshCalendars
                        });
                },
            }
        );
    });
     
    //funtion to load booking request info in iframe "emailInfoFrame" on "tbluserrequests" request row click.
    //called by : rows in tbluserrequests on click
    function loadrequest(id, linkedCalendarIDs, ele) {
        $("#tbluserrequests tr").attr("style", "");
        $(ele).attr("style", "background-color: #aaa;");
        $("#hdnrequestid").val(id);
        $("#btnProcessed").attr("onclick", "updateStatus('" + "@Url.Action("Invalidate", "BookingRequest", new { id = "requestid" })".replace("requestid", id) + "')");
        $("#emailInfoFrame")[0].contentWindow.location.replace("/Api/GetEmailHTML.aspx?emailID=" + id);
        
        if (calendar !== undefined) {
            calendar.updateBackendURLs("@Url.Content("~/Calendar/Day?calendarIDs=")" + linkedCalendarIDs, "@Url.Content("~/Calendar/Month?calendarIDs=")" + linkedCalendarIDs, "@Url.Content("~/Calendar/Navigator?calendarIDs=")" + linkedCalendarIDs);
        }
    }

    function afterRender() {
            dp_navigator.visibleRangeChangedCallBack();
    }

    //Document ready function, will run after page is ready and all elements are loaded.
    $(document).ready(function () {

        //Parsing and binding the booking requests viewer
        var table = $('#tbluserrequests').DataTable({
            order: [0, 'desc'],
            searching: false,
            ordering: false,
            bLengthChange: false,
            processing: true,
            serverSide: true, //Enabling server side processing
            ajax:
            {
                //Ajax call to get all unprocessed booking request from server according to user.
                "url": "@Url.Action("GetBookingRequests", "BookingRequest")" + "?bookingRequestId=" + "@Model.BookingRequestID",
                "dataSrc": function (json) {
                    var orgdata = JSON.parse(json.data);
                    return orgdata;
                }
            },
            //Callback function for row created.
            createdRow: function (row, data, index) {
                if (data.id == $("#hdnrequestid").val()) {
                    $(row).attr("style", "cursor:pointer;background-color: #aaa;");
                }
                else {
                    $(row).attr("style", "cursor:pointer;");
                }
            },
            columns: [
                {
                    data: function (data) {
                        return ConvertTODateString(data.date_received);
                    }
                },
                { data: 'subject' }
            ]
        });


        //This function will bind a click function on every button in table "tblbookingrequest"
        $('#tbluserrequests').on('click', 'tr', function () {
            var data = table.row($(this)).data();
            loadrequest(data.id, data.linkedcalendarids, this);
        });

        $('#btnRequestClarification').click(function () {
            if (Kwasant.IFrame.PopupsActive()) { return false; }
            Kwasant.IFrame.Display('@Url.Action("Edit", "ClarificationRequest", new { bookingRequestId = Model.BookingRequestID })',
                {
                    horizontalAlign: 'left',
                });
        });
    });

    function emailFrameLoaded() {
        var iframe = $("#emailInfoFrame").get(0);
        if (iframe) {
            // here you can make the height, I delete it first, then I make it again
            iframe.height = "";
            iframe.height = (iframe.contentWindow.document.body.scrollHeight + 30) + "px";
        }
    }

    //function to format datetime of Request viewer widget
    function ConvertTODateString(dateFormat) {
        var datevalue = new Date(dateFormat);
        dateFormat = datevalue.getMonth() + 1 + "/" + datevalue.getDate() + "/" + datevalue.getFullYear() + " " + datevalue.getHours() + ":" + datevalue.getMinutes();
        return dateFormat;
    }

    //Mark processed function will execute on click to update the Request status to "Processed".
    function updateStatus(path) {
        $.getJSON(path, function () {
            window.location.href = "@Url.Action("Index", "BookingRequest")";
        });
    }

    function HistoryClick(id) {
        if (Kwasant.IFrame.PopupsActive()) { return; }
        Kwasant.IFrame.Display('/Report/HistoryByBookingRequestId?bookingRequestID=' + id,
            {
                horizontalAlign: 'left',
                callback: calendar.refreshCalendars
            });
        
    }
</script>
