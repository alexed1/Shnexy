@{ Layout = "~/Views/Shared/_Blank.cshtml"; }

<script src="~/Content/js/jquery.js"></script>
<script src="~/Scripts/DataTables-1.10.0/media/js/jquery.dataTables.js"></script>
<link href="~/Content/DataTables-1.10.0/media/css/jquery.dataTables.css" rel="stylesheet" />
<link href="~/Content/css/backendcss/default.css" rel="stylesheet" />
<input type="button" value="close" onclick="closethis();" />
<table id="tblusers"  class="table table-with-action">
    <thead>
        <tr>
            <th>First Name</th>
            <th>Last Name</th>
            <th>Email Address</th>
            <th>Role</th>
            <th class="action-cell">Action</th>
        </tr>
    </thead>
</table>
<script type="text/javascript">
    //Document ready function, will run after page is ready and all elements are loaded.
    $(document).ready(function () {
        //Ajax call to get all users from server.
        $.getJSON("@Url.Action("GetAllUsers", "User")", {}, showUsers);

        //Load all users into DataTable Widget
        function showUsers(response) {
            //This configuration supports one button "select" to choose any user from the table and several columns of user info
            var table = $('#tblusers').DataTable({
                data: JSON.parse(response),
                columns: [
                    { data: 'first_name' },
                    { data: 'last_name' },
                    { data: 'email_address' },
                    { data: 'role' },
                    {
                        data: null,
                        defaultContent: "<button value='select'>Select</button>"
                    }
                ],
            });

            //This function will bind a click function on every button in table "tblusers"
            $('#tblusers tbody').on('click', 'button', function () {
                var data = table.row($(this).parents('tr')).data();
                var parentcontrol = this;
                //checking clicked button value for appropriate action this will be "select"
                switch ($(this).val()) {
                    case "select":
                        //redirecting to main calendar view for details
                        $.getJSON("@Url.Action("GetCalendars", "User")", { "curUserId": data.user_id }, populateCalendarChooser);
                        $("#txtemailid", window.parent.document).val(data.email_address);
                        break;
                    default:
                        //generates an alert for invalid selection, generally it won't happen.
                        alert("Not a valid action!");
                }
            });
        }

        //This function will update the calendars on "User/Admin" view
        function populateCalendarChooser(response) {
            var calendarChooserBox = $("#divCalendarChooser", window.parent.document);
            calendarChooserBox.html("");
            response = JSON.parse(response);
            $(response).each(function () {
                calendarChooserBox.append("<input type='checkbox' data-id='" + this.id + "' value='" + this.id + "' onclick='refreshCalendar()' checked='checked' />" + this.name);
            });
            //Refreshing the calendar at "User/Administer"
            window.parent.refreshCalendar();
            closethis();
        }
    });

    //Function closing the current window.
    function closethis() {
        $(window.parent.document).find("iframe").each(function () {
            if ($(this).attr("style").indexOf("z-index") > 0) {
                if ($(this).attr("style").indexOf("display: none") < 0) {
                    $(this).remove();
                }
            }
        });
    }
</script>